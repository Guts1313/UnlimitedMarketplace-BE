stages:
  - build_and_test
  - docker_build

variables:
  SONAR_HOST_URL: "http://localhost:9000"
  SONAR_LOGIN: "sqp_5b08838331b3c75e02deb42791f8c40d7081f695"

build_and_test:
  stage: build_and_test
  image: gradle:latest  # Use a Docker image that has Gradle and JDK installed
  script:
    - cd unlimitedmarketplace-V2/unlimitedmarketplace  # Change directory to where the settings.gradle file is located
    - gradle clean build
    - gradle test
    - gradle sonarqube -Dsonar.projectKey=ProjectKey -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_LOGIN
  tags:
    - docker  # Make sure this tag matches a runner configured to use Docker

docker_build:
  stage: docker_build
  image: docker:19.03.12
  services:
    - name: docker:19.03.12-dind
  before_script:
    - docker info
  script:
    - cd unlimitedmarketplace-V2/unlimitedmarketplace  # Ensure you're in the right directory to access the Dockerfile
    - docker build -t unlimitedmarketplace_backend:latest .

